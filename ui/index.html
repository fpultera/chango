<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chango üêµ</title>
    <style>
        :root { --sidebar-bg: #1e1f22; --chat-bg: #313338; --user-bg: #2b2d31; --accent: #5865f2; --hover: #35373c; --danger: #da373c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; color: #dbdee1; background: var(--chat-bg); overflow: hidden; }
        
        /* Auth Overlay */
        #auth-overlay { position: fixed; inset: 0; background: #1e1f22; z-index: 100; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: #313338; padding: 30px; border-radius: 8px; width: 300px; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 4px; border: none; background: #1e1f22; color: white; box-sizing: border-box; }
        
        /* Sidebar y Canales */
        #sidebar { width: 220px; background: var(--sidebar-bg); padding: 15px; display: flex; flex-direction: column; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; color: white; margin-bottom: 20px; }
        #channel-list { flex: 1; overflow-y: auto; }
        .channel-btn { padding: 10px; border-radius: 5px; cursor: pointer; transition: 0.2s; margin-bottom: 2px; }
        .channel-btn.active { background: var(--accent); color: white; }
        .channel-btn:hover:not(.active) { background: var(--hover); }

        /* Principal */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { padding: 15px; font-weight: bold; border-bottom: 1px solid #26272d; display: flex; justify-content: space-between; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .message { background: #383a40; padding: 10px; border-radius: 8px; max-width: 85%; align-self: flex-start; word-wrap: break-word; }
        
        /* Lista de Usuarios */
        #user-list { width: 180px; background: var(--sidebar-bg); padding: 15px; border-left: 1px solid #26272d; }
        .user-item { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 0.9em; cursor: pointer; padding: 5px; border-radius: 4px; }
        .user-item:hover { background: var(--hover); }
        .dot { width: 8px; height: 8px; background: #23a55a; border-radius: 50%; }

        /* Input */
        .input-area { padding: 20px; background: var(--chat-bg); }
        input#msgInput { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #383a40; color: white; outline: none; box-sizing: border-box; }

        /* NOTIFICACIONES DE BURBUJA */
        #notif-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--accent); color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); cursor: pointer; animation: slideIn 0.3s ease; min-width: 200px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        button.logout-btn { margin-top: 10px; background: var(--danger); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="notif-container"></div>

<div id="auth-overlay">
    <div class="auth-box">
        <h2 style="color: white">Chango üêµ</h2>
        <input type="text" id="username" placeholder="Usuario">
        <input type="password" id="password" placeholder="Contrase√±a">
        <button onclick="auth('login')" style="width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">Entrar</button>
        <button onclick="auth('register')" style="background:none; color:var(--accent); border:none; margin-top:10px; cursor:pointer">Reg√≠strate</button>
    </div>
</div>

<div id="sidebar">
    <div class="sidebar-header"><h3>Canales</h3><span style="cursor:pointer; font-size: 1.5em;" onclick="createNewChannel()">+</span></div>
    <div id="channel-list"></div>
    <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
</div>

<div id="main">
    <header>
        <span># <span id="channelName">general</span></span>
        <span id="myIdentity" style="font-size: 0.8em; color: #949ba4;"></span>
    </header>
    <div id="chat"></div>
    <div class="input-area">
        <div id="typing-status" style="height: 20px; font-size: 0.8em; font-style: italic; color: #b5bac1; margin-bottom: 5px;"></div>
        <input type="text" id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
    </div>
</div>

<div id="user-list">
    <h4 style="color: #949ba4; font-size: 0.75em; margin-bottom: 15px; text-transform: uppercase;">Online</h4>
    <div id="online-users"></div>
</div>

<script>
    let currentChannel = 'general';
    let recipientID = null;
    let userName = localStorage.getItem('chango_user');
    let token = localStorage.getItem('chango_token');
    
    const chat = document.getElementById("chat");
    const input = document.getElementById("msgInput");
    const userListDiv = document.getElementById("online-users");
    const chanListDiv = document.getElementById("channel-list");
    const notifContainer = document.getElementById("notif-container");
    let socket;

    window.onload = () => { if (token && userName) showChat(); };

    async function auth(type) {
        const u = document.getElementById("username").value;
        const p = document.getElementById("password").value;
        const res = await fetch(`/api/${type}`, { method: 'POST', body: JSON.stringify({username: u, password: p}) });
        if (res.ok) {
            if (type === 'login') {
                const data = await res.json();
                token = data.token; userName = data.username;
                localStorage.setItem('chango_token', token); localStorage.setItem('chango_user', userName);
                showChat();
            } else alert("¬°Registrado correctamente!");
        } else alert("Error de credenciales");
    }

    function showChat() {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("myIdentity").innerText = `Conectado como: ${userName}`;
        loadChannels(); loadHistory(); connect();
    }

    function logout() { localStorage.clear(); window.location.reload(); }

    async function loadChannels() {
        const res = await fetch('/api/channels');
        const channels = await res.json();
        chanListDiv.innerHTML = "";
        channels.forEach(c => {
            const div = document.createElement("div");
            div.className = `channel-btn ${c.name === currentChannel ? 'active' : ''}`;
            div.innerText = `# ${c.name}`;
            div.onclick = () => { 
                recipientID = null; currentChannel = c.name; 
                switchUI(c.name, false);
                document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
                div.classList.add('active');
            };
            chanListDiv.appendChild(div);
        });
    }

    async function createNewChannel() {
        const name = prompt("Nombre del nuevo canal:");
        if (name) {
            await fetch('/api/channels', { method: 'POST', body: JSON.stringify({name: name.toLowerCase().replace(/\s/g, '-')}) });
            loadChannels();
        }
    }

    function connect() {
        if (socket) socket.close();
        socket = new WebSocket(`ws://${window.location.host}/ws?channel=${currentChannel || 'dm'}&user=${encodeURIComponent(userName)}`);
        
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            
            if (data.type === "channels_update") {
                loadChannels();
            } else if (data.type === "users_update") {
                updateUserList(data.users);
            } else if (data.is_private) {
                // L√≥gica de DM
                if ((data.recipient_id === userName && recipientID === data.channel_id) || 
                    (data.channel_id === userName && recipientID === data.recipient_id)) {
                    addMessageToUI(data.content);
                } else if (data.recipient_id === userName) {
                    // NOTIFICACI√ìN: Recib√≠ un DM pero no tengo abierto ese chat
                    showNotification(data.channel_id, data.content);
                }
            } else if (data.channel_id === currentChannel) {
                addMessageToUI(data.content);
            }
        };
    }

    function showNotification(sender, content) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.innerHTML = `<strong>${sender}</strong>: ${content.split(': ')[1] || content}`;
        toast.onclick = () => {
            recipientID = sender;
            currentChannel = null;
            switchUI("@ " + sender, true);
            toast.remove();
        };
        notifContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 5000); // Desaparece en 5 segundos
    }

    function updateUserList(users) {
        userListDiv.innerHTML = "";
        if(!users) return;
        users.forEach(u => {
            if (u === userName) return;
            const div = document.createElement("div");
            div.className = "user-item";
            div.innerHTML = `<span class="dot"></span> ${u}`;
            div.onclick = () => { 
                currentChannel = null; recipientID = u; 
                switchUI("@ " + u, true);
                document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
            };
            userListDiv.appendChild(div);
        });
    }

    function switchUI(label, isPrivate) {
        document.getElementById("channelName").innerText = label;
        chat.innerHTML = "";
        const url = isPrivate ? `/api/history/private?user1=${userName}&user2=${recipientID}` : `/api/history?channel=${currentChannel}`;
        fetch(url).then(res => res.json()).then(msgs => msgs && msgs.forEach(m => addMessageToUI(m.content)));
    }

    input.onkeypress = (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
            const msg = { 
                content: `${userName}: ${input.value}`, 
                type: "chat",
                channel_id: recipientID ? userName : currentChannel,
                recipient_id: recipientID || "",
                is_private: !!recipientID
            };
            socket.send(JSON.stringify(msg));
            input.value = "";
        }
    };

    function addMessageToUI(text) {
        const div = document.createElement("div"); 
        div.className = "message";
        div.innerText = text; 
        chat.appendChild(div); 
        chat.scrollTop = chat.scrollHeight;
    }

    function loadHistory() {
        if (!currentChannel) return;
        fetch(`/api/history?channel=${currentChannel}`).then(res => res.json()).then(msgs => {
            if(msgs) msgs.forEach(m => addMessageToUI(m.content));
        });
    }
</script>
</body>
</html>