<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chango üêµ</title>
    <style>
        :root { --sidebar-bg: #1e1f22; --chat-bg: #313338; --hover-bg: #35373c; --accent: #5865f2; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; color: #dbdee1; }
        
        /* Barra Lateral */
        #sidebar { width: 240px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 10px; }
        .channel-btn { padding: 10px; border-radius: 4px; cursor: pointer; margin-bottom: 2px; transition: 0.2s; }
        .channel-btn:hover { background: var(--hover-bg); color: white; }
        .channel-btn.active { background: var(--accent); color: white; }
        
        /* √Årea de Chat */
        #main { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); }
        header { padding: 15px; background: var(--chat-bg); box-shadow: 0 1px 2px rgba(0,0,0,0.5); font-weight: bold; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .message { background: #383a40; padding: 10px; border-radius: 8px; max-width: 80%; width: fit-content; }
        
        .input-area { padding: 20px; background: var(--chat-bg); display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #383a40; color: white; outline: none; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="color: white; margin-left: 10px;">Chango üêµ</h3>
    <div class="channel-btn active" onclick="switchChannel('general', this)"># general</div>
    <div class="channel-btn" onclick="switchChannel('dev', this)"># dev</div>
    <div class="channel-btn" onclick="switchChannel('random', this)"># random</div>
</div>

<div id="main">
    <header id="channelName"># general</header>
    <div id="chat"></div>
    <div class="input-area">
        <input type="text" id="msgInput" placeholder="Enviar mensaje..." autocomplete="off">
        <button onclick="send()">Enviar</button>
    </div>
</div>

<script>
    let currentChannel = 'general';
    const userName = prompt("Tu nombre:", "Chango") || "An√≥nimo";
    const chat = document.getElementById("chat");
    const input = document.getElementById("msgInput");
    let socket;

    function connect() {
        if (socket) socket.close();
        socket = new WebSocket(`ws://${window.location.host}/ws?channel=${currentChannel}`);
        
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.channel_id === currentChannel) {
                addMessageToUI(data.content);
            }
        };
    }

    function switchChannel(channel, el) {
        currentChannel = channel;
        document.getElementById("channelName").innerText = "# " + channel;
        document.querySelectorAll('.channel-btn').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        
        chat.innerHTML = ""; // Limpiar vista
        loadHistory();       // Cargar mensajes viejos
        connect();           // Reconectar socket al nuevo canal
    }

    function loadHistory() {
        fetch(`/api/history?channel=${currentChannel}`)
            .then(res => res.json())
            .then(messages => {
                if(messages) messages.forEach(m => addMessageToUI(m.content));
            });
    }

    function addMessageToUI(text) {
        const div = document.createElement("div");
        div.className = "message";
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function send() {
        if (input.value) {
            socket.send(JSON.stringify({
                content: `${userName}: ${input.value}`,
                channel_id: currentChannel
            }));
            input.value = "";
        }
    }

    input.onkeypress = (e) => { if(e.key === 'Enter') send() };
    
    // Inicio
    loadHistory();
    connect();
</script>
</body>
</html>