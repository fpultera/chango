<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chango üêµ</title>
    <style>
        :root { --sidebar-bg: #1e1f22; --chat-bg: #313338; --user-bg: #2b2d31; --accent: #5865f2; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; color: #dbdee1; background: var(--chat-bg); overflow: hidden; }
        #sidebar { width: 200px; background: var(--sidebar-bg); padding: 15px; display: flex; flex-direction: column; gap: 5px; }
        .channel-btn { padding: 10px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .channel-btn:hover { background: #35373c; }
        .channel-btn.active { background: var(--accent); color: white; }
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .message { background: #383a40; padding: 10px; border-radius: 8px; max-width: 85%; align-self: flex-start; }
        #user-list { width: 180px; background: var(--sidebar-bg); padding: 15px; border-left: 1px solid #26272d; }
        .user-item { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 0.9em; color: #949ba4; }
        .dot { width: 8px; height: 8px; background: #23a55a; border-radius: 50%; }
        .input-area { padding: 20px; background: var(--chat-bg); }
        .input-row { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #383a40; color: white; outline: none; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #typing-status { height: 20px; font-size: 0.8em; color: #b5bac1; font-style: italic; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="color: white; margin-bottom: 20px;">Chango üêµ</h3>
    <div class="channel-btn active" onclick="switchChannel('general', this)"># general</div>
    <div class="channel-btn" onclick="switchChannel('dev', this)"># dev</div>
    <div class="channel-btn" onclick="switchChannel('random', this)"># random</div>
</div>

<div id="main">
    <header style="padding: 15px; font-weight: bold; border-bottom: 1px solid #26272d;"># <span id="channelName">general</span></header>
    <div id="chat"></div>
    <div class="input-area">
        <div id="typing-status"></div>
        <div class="input-row">
            <input type="text" id="msgInput" placeholder="Enviar mensaje..." autocomplete="off">
            <button onclick="send()">Enviar</button>
        </div>
    </div>
</div>

<div id="user-list">
    <h4 style="color: white; text-transform: uppercase; font-size: 0.75em; margin-bottom: 15px; letter-spacing: 0.5px;">Usuarios Online</h4>
    <div id="online-users"></div>
</div>

<script>
    let currentChannel = 'general';
    const userName = prompt("¬øC√≥mo te llamas hoy?", "Chango_" + Math.floor(Math.random()*99)) || "Anonimo";
    const chat = document.getElementById("chat");
    const input = document.getElementById("msgInput");
    const typingStatus = document.getElementById("typing-status");
    const userListDiv = document.getElementById("online-users");
    let socket;
    let typingTimeout;

    function connect() {
        if (socket) socket.close();
        socket = new WebSocket(`ws://${window.location.host}/ws?channel=${currentChannel}&user=${encodeURIComponent(userName)}`);
        
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            
            if (data.type === "users_update") {
                updateUserList(data.users);
            } else if (data.type === "typing" && data.channel_id === currentChannel) {
                if (!data.content.includes(userName)) typingStatus.innerText = data.content;
            } else if (data.type === "stop_typing" && data.channel_id === currentChannel) {
                typingStatus.innerText = "";
            } else if (data.type === "chat" || !data.type) {
                if (data.channel_id === currentChannel) {
                    addMessageToUI(data.content);
                    typingStatus.innerText = "";
                }
            }
        };
    }

    function updateUserList(users) {
        if (!users) return;
        userListDiv.innerHTML = "";
        // Limpiar duplicados visuales por si acaso
        [...new Set(users)].forEach(u => {
            const div = document.createElement("div");
            div.className = "user-item";
            div.innerHTML = `<span class="dot"></span> ${u}`;
            userListDiv.appendChild(div);
        });
    }

    input.addEventListener('input', () => {
        socket.send(JSON.stringify({ type: "typing", content: `${userName} est√° escribiendo...`, channel_id: currentChannel }));
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.send(JSON.stringify({ type: "stop_typing", channel_id: currentChannel }));
        }, 1500);
    });

    function send() {
        if (input.value.trim()) {
            socket.send(JSON.stringify({ type: "chat", content: `${userName}: ${input.value}`, channel_id: currentChannel }));
            input.value = "";
        }
    }

    function switchChannel(channel, el) {
        currentChannel = channel;
        document.getElementById("channelName").innerText = channel;
        document.querySelectorAll('.channel-btn').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        chat.innerHTML = "";
        loadHistory();
        connect();
    }

    function loadHistory() {
        fetch(`/api/history?channel=${currentChannel}`).then(res => res.json()).then(msgs => {
            if(msgs) msgs.forEach(m => addMessageToUI(m.content));
        });
    }

    function addMessageToUI(text) {
        const div = document.createElement("div");
        div.className = "message";
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    input.onkeypress = (e) => { if(e.key === 'Enter') send() };
    loadHistory();
    connect();
</script>
</body>
</html>